<div class="mx-auto w-full overflow-hidden rounded-sm bg-white shadow-md p-2 md:p-4">
    <div class="flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <button (click)="voltarParaLista()" class="mr-4 text-gray-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100 
                        transition-colors bg-transparent">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </button>
                <h1 class="text-2xl font-bold">
                    {{ isEditing ? 'Editar Venda' : 'Nova Venda' }}
                </h1>
            </div>
        </div>

        <!-- Loading indicator -->
        <div *ngIf="loading" class="flex justify-center items-center h-32">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">Carregando...</p>
            </div>
        </div>

        <form [formGroup]="form" (ngSubmit)="salvarVenda()" *ngIf="!loading" class="space-y-6">
            <!-- Informações da Venda -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium mb-4 text-gray-700">Informações da Venda</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                    <div class="relative">
                        <label for="cliente" class="block text-sm font-medium text-gray-700 mb-1">
                            Cliente *
                        </label>
                        <input 
                            type="text" 
                            id="cliente" 
                            formControlName="cliente" 
                            (input)="onClienteInputChange($event)"
                            (focus)="onClienteFocus()"
                            (blur)="onClienteBlur()"
                            placeholder="Digite o nome do cliente (cadastrado ou não)..."
                            autocomplete="off"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            [class.border-red-500]="form.get('cliente')?.invalid && form.get('cliente')?.touched">
                          <!-- Dropdown com sugestões de clientes -->
                        <div *ngIf="showClienteDropdown" 
                            class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                            <div *ngFor="let cliente of clientesFiltrados" 
                                (click)="selecionarCliente(cliente)"
                                class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">{{ cliente.nome }}</span>
                                    <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">Cadastrado</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1" *ngIf="cliente.celular">
                                    {{ cliente.celular }}
                                </div>
                            </div>
                            <div *ngIf="clientesFiltrados.length === 0" class="px-3 py-2 text-gray-500 text-sm">
                                Nenhum cliente cadastrado encontrado. Você pode continuar digitando qualquer nome.
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Você pode selecionar um cliente cadastrado ou digitar qualquer nome
                        </div>
                    </div>

                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data da Venda *
                        </label>
                        <input type="date" id="data" formControlName="data"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            [class.border-red-500]="form.get('data')?.invalid && form.get('data')?.touched">
                    </div>
                </div>
                
                <!-- Campo de Observação -->
                <div class="mt-4">
                    <label for="observacao" class="block text-sm font-medium text-gray-700 mb-1">
                        Observação
                    </label>
                    <textarea 
                        id="observacao" 
                        formControlName="observacao" 
                        rows="3"
                        placeholder="Digite alguma observação sobre a venda (opcional)..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">
                    </textarea>
                    <div class="text-xs text-gray-500 mt-1">
                        Campo opcional para anotações sobre a venda
                    </div>
                </div>
            </div>

            <!-- Adicionar Produtos -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium mb-4 text-gray-700">Adicionar Produtos</h3>                <form (submit)="adicionarProduto()" [formGroup]="formProdutos">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">                        <div class="relative">
                            <label for="produto" class="block text-sm font-medium text-gray-700 mb-1">
                                Produto *
                            </label>
                            <input 
                                type="text" 
                                id="produto" 
                                formControlName="produto" 
                                (input)="onProdutoInputChange($event)"
                                (focus)="onProdutoFocus()"
                                (blur)="onProdutoBlur()"
                                placeholder="Digite o nome do produto..."
                                autocomplete="off"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            
                            <!-- Dropdown com sugestões -->
                            <div *ngIf="showDropdown" 
                                class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                                <div *ngFor="let produto of produtosFiltrados" 
                                    (click)="selecionarProduto(produto)"
                                    class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">{{ produto.nome }}</span>
                                        <span class="text-sm text-gray-500">Estoque: {{ produto.estoque }}</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        Preço: {{ produto.preco_venda | currency:'BRL' }}
                                    </div>
                                </div>
                                <div *ngIf="produtosFiltrados.length === 0" class="px-3 py-2 text-gray-500 text-sm">
                                    Nenhum produto encontrado
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="quantidade" class="block text-sm font-medium text-gray-700 mb-1">
                                Quantidade *
                            </label>
                            <input type="number" id="quantidade" formControlName="quantidade" min="0.01" step="0.01"
                                placeholder="0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label for="precoCompra" class="block text-sm font-medium text-gray-600 mb-1">
                                Preço Compra (Ref.)
                            </label>
                            <input type="text" id="precoCompra" readonly
                                [value]="getProdutoSelecionado()?.preco_compra | currency:'BRL'"
                                class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-600 cursor-not-allowed">
                        </div>

                        <div>
                            <label for="preco" class="block text-sm font-medium text-gray-700 mb-1">
                                Preço Venda *
                            </label>
                            <input type="number" id="preco" formControlName="preco" min="0.01" step="0.01"
                                placeholder="0.00"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>                        <div>
                            <label for="unidadeMedida" class="block text-sm font-medium text-gray-700 mb-1">
                                Unidade *
                            </label>
                            <input type="text" 
                                   id="unidadeMedida" 
                                   formControlName="unidadeMedida" 
                                   readonly
                                   placeholder="Selecione um produto primeiro"
                                   class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-600 cursor-not-allowed">
                        </div>
                    </div>                    <button type="submit" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i>
                        Adicionar Produto
                    </button>

                    <!-- Indicador de Lucro Previsto -->
                    <div *ngIf="getProdutoSelecionado() && formProdutos.get('quantidade')?.value && formProdutos.get('preco')?.value" 
                         class="mt-3 p-3 bg-blue-100 rounded-md">
                        <div class="text-sm text-blue-800">
                            <strong>Lucro previsto:</strong> 
                            <span [ngClass]="{'text-green-600': calcularLucroPrevisto() > 0, 'text-red-600': calcularLucroPrevisto() < 0}">
                                {{ calcularLucroPrevisto() | currency:'BRL' }}
                            </span>
                            <span class="text-xs text-blue-600 ml-2">
                                ({{ calcularMargemLucro() | number:'1.1-1' }}% margem)
                            </span>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Lista de Produtos Adicionados -->
            <div *ngIf="produtosVenda.length > 0" class="bg-green-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium mb-4 text-gray-700">Produtos da Venda</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-2 px-3 text-sm font-medium text-gray-700">Produto</th>
                                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Quantidade</th>
                                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Preço Unit.</th>
                                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Total</th>
                                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Lucro</th>
                                <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Ações</th>
                            </tr>
                        </thead>
                        <tbody>                            <tr *ngFor="let produto of produtosVenda; let i = index" class="border-b border-gray-100">
                                <td class="py-2 px-3 text-sm">{{ produto.nome }}</td>
                                <td class="py-2 px-3 text-sm text-center">{{ produto.quantidade }} {{
                                    produto.unidade_medida }}</td>
                                <td class="py-2 px-3 text-sm text-center">{{ produto.preco_venda | currency:'BRL' }}
                                </td>
                                <td class="py-2 px-3 text-sm text-center font-medium">{{ produto.total | currency:'BRL'
                                    }}</td>
                                <td class="py-2 px-3 text-sm text-center" 
                                    [ngClass]="{'text-green-600': produto.lucro > 0, 'text-red-600': produto.lucro < 0}">
                                    {{ produto.lucro | currency:'BRL' }}
                                </td>
                                <td class="py-2 px-3 text-sm text-center">
                                    <button type="button" (click)="removerProduto(i)"
                                        class="text-red-600 hover:text-red-800 p-1 bg-transparent">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>                        <tfoot>
                            <tr class="border-t-2 border-gray-300 bg-gray-50">
                                <td colspan="3" class="py-3 px-3 text-sm font-bold text-right">Total da Venda:</td>
                                <td class="py-3 px-3 text-sm font-bold text-center">{{ calcularTotal() | currency:'BRL'
                                    }}</td>
                                <td class="py-3 px-3 text-sm font-bold text-center"
                                    [ngClass]="{'text-green-600': calcularLucroTotal() > 0, 'text-red-600': calcularLucroTotal() < 0}">
                                    {{ calcularLucroTotal() | currency:'BRL' }}
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Mensagem quando não há produtos -->
            <div *ngIf="produtosVenda.length === 0" class="text-center py-8 text-gray-500">
                <i class="fa-solid fa-shopping-cart text-3xl mb-3"></i>
                <p>Nenhum produto adicionado à venda</p>
                <p class="text-sm">Selecione um produto acima para começar</p>
            </div>

            <!-- Botões de Ação -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                <button type="button" (click)="voltarParaLista()"
                    class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit" [disabled]="form.invalid || produtosVenda.length === 0"
                    class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                    <i class="fa-solid fa-save mr-2"></i>
                    {{ isEditing ? 'Atualizar Venda' : 'Salvar Venda' }}
                </button>
            </div>
        </form>
    </div>
</div>