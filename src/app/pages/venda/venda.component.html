<div class="mx-auto w-full overflow-hidden rounded-sm bg-white shadow-md p-2 md:p-4">
    <div class="flex flex-col">
        <h1 class="text-2xl p-4 font-bold">VENDAS</h1>

        <!-- Campo de busca -->
        <div class="flex flex-col md:flex-row items-center mb-4 px-2">
            <div class="flex flex-1 w-full md:w-auto">
                <input type="text" placeholder="Buscar venda por cliente..."
                    class="border rounded-l px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                    [(ngModel)]="searchTerm">
                <button class="bg-blue-500 text-white px-4 py-2 hover:bg-blue-600 focus:outline-none"
                    (click)="buscarPorTermo(searchTerm)">
                    <i class="fa-solid fa-search"></i>
                </button>
                <button class="bg-gray-300 text-gray-700 px-4 py-2 rounded-r hover:bg-gray-400 focus:outline-none"
                    (click)="limparBusca()" [disabled]="!searchTerm"
                    [ngClass]="{'opacity-50 cursor-not-allowed': !searchTerm}">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <button type="button" (click)="onCreateItem()" 
                class="p-2 px-4 ml-0 md:ml-4 mt-2 md:mt-0 bg-blue-500 hover:bg-blue-600 focus:outline-2 
                focus:outline-offset-2 focus:outline-blue-500 active:bg-blue-700 rounded-md text-white font-medium">
                <i class="fa-solid fa-plus mr-2"></i>Nova Venda
            </button>
        </div>

        <!-- Tabela de Vendas -->
        <div class="overflow-x-auto">
            <table class="min-w-full border-collapse shadow-sm rounded-lg">
                <thead>
                    <tr class="border-b-2 bg-blue-100">
                        <th class="p-3 text-left text-sm font-medium text-gray-700">Cliente</th>
                        <th class="p-3 text-center text-sm font-medium text-gray-700">Data</th>
                        <th class="p-3 text-center text-sm font-medium text-gray-700">Produtos</th>
                        <th class="p-3 text-right text-sm font-medium text-gray-700">Valor Total</th>
                        <th class="p-3 text-center text-sm font-medium text-gray-700">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let venda of items">
                        <tr class="border-b hover:bg-gray-50 transition-colors">
                            <td class="p-3 text-sm font-medium text-gray-800">{{ venda.cliente }}</td>
                            <td class="p-3 text-sm text-center text-gray-600">{{ formatarData(venda.data) }}</td>
                            <td class="p-3 text-sm text-center">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ venda.produtos.length || 0 }} item(ns)
                                </span>
                            </td>
                            <td class="p-3 text-sm text-right font-bold text-gray-800">
                                {{ venda.valor_total | currency:'BRL':'symbol':'1.2-2' }}
                            </td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center space-x-2">
                                    <button (click)="toggleExpand(venda)" 
                                        class="text-gray-600 hover:text-gray-800 p-1 bg-transparent"
                                        [title]="venda.expandido ? 'Ocultar detalhes' : 'Ver detalhes'">
                                        <i class="fa-solid" 
                                           [class.fa-chevron-down]="!venda.expandido" 
                                           [class.fa-chevron-up]="venda.expandido"></i>
                                    </button>                                    <button (click)="imprimirCupom(venda)" 
                                        class="text-green-600 hover:text-green-800 p-1 bg-transparent"
                                        title="Gerar PDF do cupom">
                                        <i class="fa-solid fa-file-pdf"></i>
                                    </button>
                                    <button (click)="imprimirCupomDireto(venda)" 
                                        class="text-blue-600 hover:text-blue-800 p-1 bg-transparent"
                                        title="Imprimir cupom diretamente">
                                        <i class="fa-solid fa-print"></i>
                                    </button>
                                    <button (click)="onEditItem(venda)" 
                                        class="text-blue-600 hover:text-blue-800 p-1 bg-transparent"
                                        title="Editar venda">
                                        <i class="fa-regular fa-pen-to-square"></i>
                                    </button>
                                    <button (click)="showModalDelete(venda)" 
                                        class="text-red-600 hover:text-red-800 p-1 bg-transparent"
                                        title="Excluir venda">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                          <!-- Linha expandida com detalhes dos produtos -->
                        <tr *ngIf="venda.expandido" class="bg-gray-50">
                            <td colspan="5" class="p-4">
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">Produtos da Venda</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">                                            <thead>
                                                <tr class="border-b border-gray-200">
                                                    <th class="text-left py-2 px-3 text-xs font-medium text-gray-600">Produto</th>
                                                    <th class="text-center py-2 px-3 text-xs font-medium text-gray-600">Qtd</th>
                                                    <th class="text-center py-2 px-3 text-xs font-medium text-gray-600">Preço Unit.</th>
                                                    <th class="text-right py-2 px-3 text-xs font-medium text-gray-600">Total</th>
                                                    <th class="text-right py-2 px-3 text-xs font-medium text-gray-600">Lucro</th>
                                                </tr>
                                            </thead>
                                            <tbody>                                                <tr *ngFor="let produto of venda.produtos" class="border-b border-gray-100">
                                                    <td class="py-2 px-3 text-xs text-gray-700">{{ produto.nome }}</td>
                                                    <td class="py-2 px-3 text-xs text-center text-gray-600">
                                                        {{ produto.quantidade }} {{ produto.unidade_medida }}
                                                    </td>
                                                    <td class="py-2 px-3 text-xs text-center text-gray-600">
                                                        {{ produto.preco_venda | currency:'BRL':'symbol':'1.2-2' }}
                                                    </td>
                                                    <td class="py-2 px-3 text-xs text-right font-medium text-gray-700">
                                                        {{ produto.total | currency:'BRL':'symbol':'1.2-2' }}
                                                    </td>                                                    <td class="py-2 px-3 text-xs text-right font-medium"
                                                        [ngClass]="{'text-green-600': (produto.lucro || 0) > 0, 'text-red-600': (produto.lucro || 0) < 0}">
                                                        {{ (produto.lucro || 0) | currency:'BRL':'symbol':'1.2-2' }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="border-t-2 border-gray-300 bg-gray-100">
                                                    <td colspan="3" class="py-2 px-3 text-xs font-bold text-right">Totais:</td>
                                                    <td class="py-2 px-3 text-xs text-right font-bold text-gray-700">
                                                        {{ venda.valor_total | currency:'BRL':'symbol':'1.2-2' }}
                                                    </td>
                                                    <td class="py-2 px-3 text-xs text-right font-bold"
                                                        [ngClass]="{'text-green-600': (venda.lucro_total || 0) > 0, 'text-red-600': (venda.lucro_total || 0) < 0}">
                                                        {{ (venda.lucro_total || 0) | currency:'BRL':'symbol':'1.2-2' }}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    
                                    <!-- Observação da Venda -->
                                    <div *ngIf="venda.observacao && venda.observacao.trim()" class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                                        <h5 class="text-xs font-medium text-blue-800 mb-2">Observação:</h5>
                                        <p class="text-xs text-blue-700">{{ venda.observacao }}</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                    
                    <!-- Estado vazio -->
                    <tr *ngIf="items.length === 0">
                        <td colspan="5" class="p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fa-solid fa-receipt text-gray-300 text-4xl mb-4"></i>
                                <p class="text-lg">Nenhuma venda encontrada</p>
                                <p class="text-sm">Clique em "Nova Venda" para começar</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>        <!-- Controles de Paginação -->
        <div class="flex flex-col md:flex-row justify-between items-center mt-4 px-2">
            <!-- Informação da página -->
            <div class="text-sm text-gray-600 mb-2 md:mb-0">
                <span *ngIf="totalItems > 0">
                    Mostrando {{ (currentPage - 1) * pageSize + 1 }} a {{ Math.min(currentPage * pageSize, totalItems)
                    }} de {{ totalItems }} vendas
                </span>
                <span *ngIf="totalItems === 0">
                    Nenhum resultado encontrado
                </span>
            </div>

            <!-- Navegação entre páginas -->
            <div class="flex items-center space-x-2" *ngIf="totalItems > 0">
                <!-- Botão para primeira página -->
                <button class="px-3 py-1 border rounded hover:bg-gray-100" [disabled]="currentPage === 1"
                    [ngClass]="{'opacity-50 cursor-not-allowed': currentPage === 1, 'cursor-pointer': currentPage !== 1}"
                    (click)="primeiraPagina()">
                    <i class="fa-solid fa-angles-left"></i>
                </button>

                <!-- Botão para página anterior -->
                <button class="px-3 py-1 border rounded hover:bg-gray-100" [disabled]="currentPage === 1"
                    [ngClass]="{'opacity-50 cursor-not-allowed': currentPage === 1, 'cursor-pointer': currentPage !== 1}"
                    (click)="paginaAnterior()">
                    <i class="fa-solid fa-angle-left"></i>
                </button>

                <!-- Indicador de página atual -->
                <span class="px-3 py-1">
                    Página {{ currentPage }} de {{ totalPages || 1 }}
                </span>

                <!-- Botão para próxima página -->
                <button class="px-3 py-1 border rounded hover:bg-gray-100" [disabled]="currentPage >= totalPages"
                    [ngClass]="{'opacity-50 cursor-not-allowed': currentPage >= totalPages, 'cursor-pointer': currentPage < totalPages}"
                    (click)="proximaPagina()">
                    <i class="fa-solid fa-angle-right"></i>
                </button>
            </div>

            <!-- Seletor de itens por página -->
            <div class="flex items-center space-x-2 mt-2 md:mt-0" *ngIf="totalItems > 0">
                <span class="text-sm text-gray-600">Itens por página:</span>
                <select class="border rounded px-2 py-1 text-sm" (change)="alterarTamanhoPagina($event)">
                    <option *ngFor="let size of pageSizeOptions" [value]="size" [selected]="pageSize === size">
                        {{ size }}
                    </option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação de exclusão -->
<app-confirm-modal 
    [show]="showDeleteModal" 
    [message]="'Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.'" 
    (confirm)="onDeleteItem()" 
    (cancel)="onCancel()">
</app-confirm-modal>